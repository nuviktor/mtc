#!/bin/sh

is_installed() {
  command -v "$1" >/dev/null 2>&1
}

mtc_is_running() {
  # The existence of the mtc ipset strongly suggests mtc has been initialised
  ipset list mtc >/dev/null 2>&1
}

if (( $(id -u) != 0 )); then
  echo "Must be ran as root" >&2
  exit 1
fi

is_installed tc || { echo "tc not installed" >&2; exit 1; }
is_installed ipset || { echo "ipset not installed" >&2; exit 1; }

mark_value=6

case "$1" in
  init)
    # Limits in KB/s
    download_limit="${MTC_DL_LIMIT:-347}"
    upload_limit="${MTC_UL_LIMIT:-59}"
    network=192.168.1.0/24

    if mtc_is_running; then
      echo "MTC already appears to be running" >&2
      exit 1
    fi

    echo "MTC initialising"
    echo
    echo "Download limit: $download_limit KB/s"
    echo "Upload limit: $upload_limit KB/s"

    # Set up all interfaces with an HTB qdisc with a fast lane and an SFQ child qdisc
    for dev in wlan0 wlan1 eth0; do
      tc qdisc add dev "$dev" root handle 1: htb default 11

      tc class add dev "$dev" parent 1: classid 1:1 htb rate 100mbit ceil 100mbit
      tc class add dev "$dev" parent 1:1 classid 1:11 htb rate 100mbit ceil 100mbit

      tc qdisc add dev "$dev" parent 1:11 handle 10: sfq perturb 10
    done

    # Add the slow lane for the wireless interfaces, where packets being downloaded will be sent
    for dev in wlan0 wlan1; do
      tc class add dev "$dev" parent 1:1 classid 1:10 htb \
       rate "${download_limit}kbps" \
       ceil "${download_limit}kbps" burst 20k
    done

    # Add the same for the Internet-facing interface
    tc class add dev eth0 parent 1:1 classid 1:10 htb \
     rate "${upload_limit}kbps" \
     ceil "${upload_limit}kbps"

    # Add SFQ qdiscs as children to these slow lanes
    for dev in wlan0 wlan1 eth0; do
      tc qdisc add dev "$dev" parent 1:10 handle 11: sfq perturb 10
    done

    # Set up filters to send marked packets to the slow lane
    for dev in wlan0 wlan1 eth0; do
      tc filter add dev "$dev" protocol ip parent 1: prio 1 handle "$mark_value" fw flowid 1:10
    done

    # Finally create an ipset for holding a list of IP addresses and the appropriate iptables rules
    ipset new mtc bitmap:ip range "$network" timeout 0

    iptables -t mangle -F fwmark
    iptables -t mangle -A fwmark -j CONNMARK --restore-mark
    iptables -t mangle -A fwmark -m mark ! --mark 0 -j ACCEPT
    iptables -t mangle -A fwmark -m set --match-set mtc src -j MARK --set-mark "$mark_value"

    iptables -t mangle -F POSTROUTING
    iptables -t mangle -A POSTROUTING -j CONNMARK --save-mark

    echo
    echo "MTC initialised"
  ;; # init

  clear|flush)
    if ! mtc_is_running; then
      echo "MTC doesn't appear to be running" >&2
      exit 1
    fi

    echo "Flushing list of IPs to be throttled"
    ipset flush mtc
  ;;

  halt|kill)
    if ! mtc_is_running; then
      echo "MTC already appears to be stopped" >&2
      exit 1
    fi

    echo "MTC deinitialising"

    for dev in wlan0 wlan1 eth0; do
      tc qdisc del dev "$dev" root
    done

    # Assumes my script will be the only thing editing these chains
    iptables -t mangle -F fwmark
    iptables -t mangle -F POSTROUTING

    ipset destroy mtc

    echo "MTC deinitialised"
  ;;

  count)
    echo "Connections marked: $(grep -c "mark=$mark_value" /proc/net/nf_conntrack)"
  ;;

  host)
    is_installed dig || { echo "dig not installed" >&2; exit 1; }

    if ! mtc_is_running; then
      echo "MTC doesn't appear to be running" >&2
      exit 1
    fi

    if [ ! -n "$2" ]; then
      echo "No host argument supplied." >&2
      exit 1
    fi

    ip="$(dig +short +search "$2")"

    if [ ! -n "$ip" ]; then
      echo "Could not find an IP for supplied host." >&2
      exit 1
    fi

    if [ ! -n "$3" ]; then
      echo "Adding IP address $ip (resolve from host $2) to list"
      ipset add mtc "$ip"
    else
      echo "Adding IP address $ip (resolved from host $2) to list with timeout of $3 minutes"
      ipset add mtc "$ip" timeout "$(( $3 * 60 ))"
    fi
  ;;

  list)
    if ! mtc_is_running; then
      echo "MTC doesn't appear to be running" >&2
      exit 1
    fi

    ipset list mtc
  ;;

  status)
    if mtc_is_running; then
      echo "MTC is running"
    else
      echo "MTC isn't running" >&2
      exit 1
    fi
  ;;

  help)
    echo "Usage: mtc COMMAND [...]"
    echo "       mtc IPV4-ADDRESS [TIMEOUT]"
    echo
    echo "Commands:"
    echo "  init        - initialise setup, adding qdiscs, iptables rules, etc.; to be ran before adding IPv4 address filters."
    echo "                Specifying the environment variables MTC_DL_LIMIT and MTC_UL_LIMIT in KB/s allows customisation of the"
    echo "                default limits."
    echo "  clear|flush - wipe the IPv4 addresses being throttled."
    echo "  halt|kill   - deinitialise setup, removing all qdiscs and iptables rules."
    echo "  count       - display a count of marked connections."
    echo "  host HOST [TIMEOUT]"
    echo "              - add an IP address to be throttled by hostname, an optional timeout (in minutes) can be specified."
    echo "  help        - display this help snippet."
  ;;

  *) # Assumes argument is an IPv4 address
    if [ ! -n "$1" ]; then
      echo "No arguments supplied." >&2
      exit 1
    fi

    if ! mtc_is_running; then
      echo "MTC doesn't appear to be running" >&2
      exit 1
    fi

    if [ ! -n "$2" ]; then
      echo "Adding IP address $1 to list"
      ipset add mtc "$1"
    else
      echo "Adding IP address $1 to list with timeout of $2 minutes"
      ipset add mtc "$1" timeout "$(( $2 * 60 ))"
    fi
  ;;
esac
